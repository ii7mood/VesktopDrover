# Vesktop Direct Mode Packet Hook (IPv4 + IPv6)

> **Human Note:**
This entire project was made using ChatGPT's 4o-mini-high model. My primary goal with open source projects is to learn. Using AI - especially the way I used it here - is completely counterintuitive and I understand that. This, unfortunately, is not a project that I can do on my own right now. Normally, I would set little goals that would ultimately lead me to make this by hand, but with extreme time constraints, the complexity of this project (for me), and how quickly I need this program to work - I resorted to using AI ü§∑‚Äç‚ôÇÔ∏è. I will eventually come back to this and write one on my own. Hopefully then it would be cleaner and/or more configurable.

> For reference - I prompted ChatGPT to avoid ISP detection of VoIP using UDP manipulation. My guess was that ISPs used very simple packet inspections and so I asked ChatGPT to mask them. It did the other 95% of the work - including this very README (excluding this paragraph tho). 

<br> 
‚ö†Ô∏è DISCLAIMER: This project was generated by AI (OpenAI's ChatGPT-4o). It was reviewed and tested by a human, but use it at your own risk. No warranty, no guarantees.


---

## Overview

In some regions, particularly those with heavy VoIP restrictions (e.g., UAE), Discord voice chat does not work even though the rest of the application does. This tool enables a workaround called **‚ÄúDirect Mode‚Äù**, which injects a custom LD_PRELOAD hook into **Vesktop** (the Electron wrapper for Discord).

This hook modifies specific outgoing UDP packets (SRTP on high ports) by toggling the first byte. This bypasses Deep Packet Inspection (DPI) systems that would otherwise block Discord voice. DTLS handshakes over UDP 443 are untouched, ensuring a secure connection is still established.

---

## How It Works

1. **DTLS (UDP 443) Handshake**

   - Discord uses DTLS over UDP port 443 to establish encryption keys.
   - These packets are not modified.

2. **SRTP Audio (UDP 50000‚Äì65535)**

   - Audio data is sent over SRTP on high UDP ports after DTLS completes.
   - The hook intercepts `sendto()` calls:
     - Only if the destination IP is within Discord‚Äôs Cloudflare anycast ranges:
       - **IPv4:** `162.159.0.0/16`
       - **IPv6:** `2606:4700::/32`
     - And the destination port is within `50000‚Äì65535`.

   - It flips the first byte of the UDP payload: `payload[0] ^= 0x01`.
   - This breaks DPI detection but still works with Discord‚Äôs decryption.

---

## Files

- `vesktop_drover.py` ‚Äì Launches Vesktop with LD_PRELOAD and manages hook lifecycle.
- `droverdirect.c` ‚Äì The source code for the UDP hook.
- `libdroverdirect.so` ‚Äì Compiled hook shared object.

---

## Requirements

- Linux (x86_64)
- Python 3.x
- `gcc` and build tools (`build-essential`)
- Root access (for writing files and cleaning up)
- Vesktop installed (e.g., `/usr/bin/vesktop`)

---

## Usage

### 1. Clone the repository

```bash
git clone https://github.com/yourusername/VesktopDirectHook.git
cd VesktopDirectHook
chmod +x vesktop_drover.py
```

### 2. Build the shared library

```bash
sudo ./vesktop_drover.py --setup
```

This creates `droverdirect.c` and compiles `libdroverdirect.so`.

Expected output includes:

```
‚úÖ Built direct‚Äêmode library: /path/to/libdroverdirect.so
```

### 3. Launch Vesktop with hook enabled

```bash
./vesktop_drover.py --launch /usr/bin/vesktop
```

Replace `/usr/bin/vesktop` with your actual Vesktop binary path.

### 4. Test Voice

Join any voice channel. If successful, you should no longer be stuck at ‚ÄúDTLS Connecting‚Ä¶‚Äù

Run the following to verify the modified packets:

```bash
sudo tcpdump -n -c 5 'udp portrange 50000-65535 and (dst net 162.159.0.0/16 or dst net 2606:4700::/32)' -X
```

Look for SRTP packets with the first byte flipped (e.g., `0x81` instead of `0x80`).

### 5. Cleanup (restore normal behavior)

```bash
sudo ./vesktop_drover.py --cleanup
```

This removes all generated files and stops LD_PRELOAD injection.

---

## Maintenance

- **Update Cloudflare Ranges**  
  If Discord updates their IPs, modify `is_disc_ipv4()` and `is_disc_ipv6()` in `droverdirect.c`. Then re-run setup.

- **Vesktop Updates**  
  After a Vesktop update, re-run:

  ```bash
  sudo ./vesktop_drover.py --setup
  ```

  Then test with tcpdump.

- **Debug Voice Connection**  
  After every major update or change:
    - Ensure DTLS (UDP 443) is untouched.
    - Confirm SRTP packets are modified and voice works.

---

## Verifying Cleanup

1. Run:

```bash
sudo ./vesktop_drover.py --cleanup
```

2. Check that files are gone:

```bash
ls droverdirect.c libdroverdirect.so
# Should show: No such file or directory
```

3. Launch Vesktop normally, get its PID:

```bash
pgrep -f vesktop
```

4. Check mapped libs:

```bash
sudo cat /proc/<PID>/maps | grep droverdirect
```

Should return **nothing** if cleanup worked.

5. Join a voice channel again. If you‚Äôre back to ‚ÄúDTLS Connecting‚Ä¶‚Äù, the hook was removed.

---

## Disclaimer

- Generated with assistance from OpenAI‚Äôs GPT-4o-mini-high.
- This tool modifies packet data to bypass VoIP restrictions, which may violate local laws or Discord‚Äôs Terms of Service.
- No warranty is provided. Use at your own risk.

---

## License

MIT License ‚Äî Use, modify, and redistribute freely.

---
